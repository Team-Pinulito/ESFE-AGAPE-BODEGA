@page "/login"
@layout Login
@inject AuthService AuthService
@inject NavigationManager Navigation

@using ESFE_AGAPE_BODEGA.DTOs.UsuarioDTOs;

<div class="container mt-3">
    <h3 class="text-center">Iniciar Sesión</h3>
    <EditForm Model="@loginDto" OnValidSubmit="@HandleLogin">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group text-center">
            <label for="dui">DUI</label>
            <InputText id="dui" class="form-control short-input" @bind-Value="@loginDto.DUI" />
            <ValidationMessage For="@(() => loginDto.DUI)" />
        </div>

        <div class="form-group text-center">
            <label for="password">Contraseña</label>
            <div class="input-group">
                <InputText id="password" type="@passwordInputType" class="form-control short-input" @bind-Value="@loginDto.Password" />
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline" @onclick="TogglePasswordVisibility" style="border: 0;">
                        @if (isPasswordVisible)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);"><path d="M17 8V7c0-2.757-2.243-5-5-5S7 4.243 7 7v3H6c-1.103 0-2 .897-2 2v8c0 1.103.897 2 2 2h12c1.103 0 2-.897 2-2v-8c0-1.103-.897-2-2-2H9V7c0-1.654 1.346-3 3-3s3 1.346 3 3v1h2z"></path></svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);"><path d="M20 12c0-1.103-.897-2-2-2h-1V7c0-2.757-2.243-5-5-5S7 4.243 7 7v3H6c-1.103 0-2 .897-2 2v8c0 1.103.897 2 2 2h12c1.103 0 2-.897 2-2v-8zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7z"></path></svg>
                        }
                    </button>
                </div>
            </div>
            <ValidationMessage For="@(() => loginDto.Password)" />
        </div>

        <br />
        <div class="form-group text-center">
            <button type="submit" class="btn btn-primary btn-block">Iniciar Sesión</button>
        </div>

        @if (errorMessage != null)
        {
            <div class="alert alert-danger text-center">@errorMessage</div>
        }
    </EditForm>
</div>

@code {
    private LoginUsuarioDTO loginDto = new LoginUsuarioDTO();
    private string errorMessage;
    private bool isPasswordVisible = false;
    private string passwordInputType => isPasswordVisible ? "text" : "password";

    private async Task HandleLogin()
    {
        try
        {
            var result = await AuthService.Login(loginDto);
            if (result)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Credenciales inválidas. Inténtalo de nuevo.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error en el inicio de sesión: {ex.Message}";
        }
    }

    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }
}

<style>
    .login-layout {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Ocupa toda la altura de la ventana */
        background-color: #f5f5f5; /* Color de fondo */
    }

    .short-input {
        max-width: 300px;
        margin: 0 auto;
    }

    .input-group {
        max-width: 300px;
        margin: 0 auto;
    }
</style>